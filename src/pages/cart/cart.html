<div id="header"></div>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
<style>
  body {
    font-family: "Inter", sans-serif;
    background-color: #f1f3f5;
  }
  .quantity-input {
    border-radius: 0 !important;
    height: 28px;
    padding: 0;
    font-size: 16px;
  }
  .quantity-input::-webkit-inner-spin-button,
  .quantity-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .quantity-input[type="number"] {
    -moz-appearance: textfield;
  }
  .qty-btn {
    border-radius: 50% !important;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 15px;
  }
  .d-flex.justify-content-center.align-items-center {
    gap: 4px;
  }
  .remove-btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #f8f9fa;
    border: 1px solid #ccc;
    font-size: 14px;
    color: #666;
    transition: background-color 0.2s, color 0.2s;
  }
  .remove-btn-icon:hover {
    background-color: #f8d7da;
    color: #dc3545;
  }
  .pagination {
    margin: 0;
    gap: 4px;
  }
  .page-link {
    color: #2d2d2d;
    border: 1px solid #e0e0e0;
    padding: 0.35rem 0.5rem;
    font-size: 13px;
    min-width: 32px;
    text-align: center;
    border-radius: 4px;
  }
  .page-link:hover {
    background-color: #00b207;
    color: #fff;
    border-color: #00b207;
  }
  .page-item.active .page-link {
    background-color: #00b207;
    border-color: #00b207;
    color: #fff;
  }
  .page-item.disabled .page-link {
    cursor: not-allowed;
    background-color: #f8f9fa;
  }
  .page-item {
    margin: 0;
  }
  #cart-pagination {
    flex: 0 0 auto;
  }
  #cart-pagination .pagination {
    flex-wrap: nowrap;
  }
</style>

<div class="container my-5">
  <div class="card shadow-sm rounded">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold">
          Gi·ªè h√†ng (<span id="cart-count">0</span> s·∫£n ph·∫©m)
        </h5>
        <button class="btn btn-outline-danger btn-sm" id="clearCartBtn">
          <i class="fas fa-trash me-1"></i> X√≥a t·∫•t c·∫£
        </button>
      </div>

      <div class="table-responsive" id="cart-table">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>S·∫£n ph·∫©m</th>
              <th class="text-center" style="width: 160px">S·ªë l∆∞·ª£ng</th>
              <th class="text-end" style="width: 120px">Gi√°</th>
              <th class="text-end ps-2" style="width: 40px"></th>
            </tr>
          </thead>
          <tbody id="cartBody">
            <tr id="cartLoadingRow">
              <td colspan="4" class="text-center py-4">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-3 text-end" id="cart-total-wrapper">
        <span class="me-2 fw-semibold">T·ªïng c·ªông:</span>
        <span class="fw-bold text-danger" id="cart-total">0‚Ç´</span>
      </div>

      <div
        class="d-flex justify-content-between align-items-center mt-3"
        id="cart-actions"
      >
        <a
          href="/src/pages/product/list.html"
          class="btn btn-outline-secondary rounded-pill"
        >
          ‚Üê Quay l·∫°i c·ª≠a h√†ng
        </a>

        <nav
          aria-label="Cart pagination"
          id="cart-pagination"
          style="display: none"
        >
          <ul class="pagination mb-0" id="paginationList"></ul>
        </nav>

        <button id="checkoutBtn" class="btn btn-primary px-4">
          Thanh to√°n
        </button>
      </div>

      <div
        class="text-center py-5 text-muted"
        id="empty-cart"
        style="display: none"
      >
        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
        <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
        <a
          href="/src/pages/product/list.html"
          class="btn btn-success rounded-pill px-4"
          >Ti·∫øp t·ª•c mua h√†ng</a
        >
      </div>
    </div>
  </div>
</div>
<div id="footer"></div>

<script src="/src/js/config/api.config.js"></script>
<script src="/src/js/utils/storage.js"></script>
<script src="/src/js/utils/toast.js"></script>
<script src="/src/js/utils/http.client.js"></script>
<script src="/src/js/services/auth.service.js"></script>
<script src="/src/js/services/cart.service.js"></script>

<script>
  const cartBody = document.getElementById("cartBody");
  const cartTable = document.getElementById("cart-table");
  const cartActions = document.getElementById("cart-actions");
  const emptyState = document.getElementById("empty-cart");
  const cartCountEl = document.getElementById("cart-count");
  const cartTotalEl = document.getElementById("cart-total");
  const cartTotalWrapper = document.getElementById("cart-total-wrapper");
  const clearCartBtn = document.getElementById("clearCartBtn");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const cartPagination = document.getElementById("cart-pagination");
  const paginationList = document.getElementById("paginationList");

  let cartItems = [];
  let currentPage = 1;
  let totalPages = 1;
  const itemsPerPage = 5;

  document.addEventListener("DOMContentLoaded", () => {
    initializeCartPage();
  });

  /* =================== Helpers ·∫£nh (gi·ªëng show.html) + API images =================== */
  // cache ·∫£nh theo productId
  const __cartImgCache = new Map();

  function buildImg(p) {
    if (!p) return "";
    const s = String(p).trim();
    if (/^(https?:)?\/\//i.test(s) || s.startsWith("data:")) return s;
    const base =
      (window.API_CONFIG &&
        (window.API_CONFIG.ASSET_BASE || window.API_CONFIG.BASE_URL)) ||
      window.API?.BASE_URL ||
      "";
    const cleanedBase = (base || "").replace(/\/+$/, "");
    const cleanedPath = s.replace(/^\/+/, "");
    return cleanedBase ? `${cleanedBase}/${cleanedPath}` : `/${cleanedPath}`;
  }

  function normalizeImages(arr) {
    return (arr || [])
      .map((im) => (typeof im === "string" ? im : im?.url || im?.path || ""))
      .filter(Boolean);
  }

  function resolveProductImagesUrl(productId) {
    const base =
      window.API?.PRODUCT?.IMAGES_BASE || // n·∫øu c√≥ config ri√™ng
      "/api/v1/product"; // fallback theo swagger
    return `${base}/${encodeURIComponent(productId)}/images`;
  }

  async function fetchProductMainImage(productId) {
    if (!productId) return "";
    if (__cartImgCache.has(productId)) return __cartImgCache.get(productId);
    try {
      const url = resolveProductImagesUrl(productId);
      const res = await window.HttpClient.request(url, {
        method: "GET",
        withAuth: true,
      });
      const arr = res?.data?.data || res?.data || [];
      const primary = arr.find((x) => x?.isPrimary) || arr[0];
      const raw = primary?.url || primary?.path || "";
      const finalUrl = raw ? buildImg(raw) : "";
      __cartImgCache.set(productId, finalUrl);
      return finalUrl;
    } catch (e) {
      __cartImgCache.set(productId, "");
      return "";
    }
  }

  // sau khi render trang hi·ªán t·∫°i, g·ªçi API ƒë·ªÉ fill ·∫£nh n·∫øu c√≤n thi·∫øu
  async function hydrateImagesForCurrentPage() {
    const rows = Array.from(cartBody.querySelectorAll("tr[data-id][data-pid]"));
    await Promise.all(
      rows.map(async (row) => {
        const pid = row.getAttribute("data-pid");
        if (!pid) return;
        const imgEl = row.querySelector("img.cart-row-img");
        if (!imgEl) return;

        // n·∫øu ƒë√£ l√† http(s) (t·ª©c ƒë√£ c√≥ ·∫£nh) th√¨ b·ªè qua
        if (/^(https?:)?\/\//i.test(imgEl.getAttribute("src"))) return;

        const url = await fetchProductMainImage(pid);
        if (url) imgEl.src = url;
      })
    );
  }
  /* ================================================================================ */

  function execScriptsIn(container) {
    if (!container) return Promise.resolve();
    const scripts = Array.from(container.querySelectorAll("script"));
    const loaders = scripts.map((oldScript) => {
      const s = document.createElement("script");
      if (oldScript.type) s.type = oldScript.type;
      if (oldScript.noModule) s.noModule = true;
      if (oldScript.defer) s.defer = true;
      if (oldScript.crossOrigin) s.crossOrigin = oldScript.crossOrigin;
      if (oldScript.integrity) s.integrity = oldScript.integrity;

      if (oldScript.src) {
        s.src = oldScript.src;
        s.async = false;
        const done = new Promise((res) => {
          s.onload = res;
          s.onerror = res;
        });
        oldScript.parentNode.replaceChild(s, oldScript);
        return done;
      }
      s.textContent = oldScript.textContent;
      oldScript.parentNode.replaceChild(s, oldScript);
      return Promise.resolve();
    });
    return Promise.all(loaders);
  }

  async function initializeCartPage() {
    try {
      await loadHeaderFooter();

      const isAuth = window.Storage?.isAuthenticated?.();
      const token = window.Storage?.getAccessToken?.();
      if (!isAuth || !token) {
        window.Toast?.warn?.("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng");
        setTimeout(() => {
          window.location.href = "/src/pages/auth/login.html";
        }, 1200);
        return;
      }

      clearCartBtn?.addEventListener("click", handleClearCart);
      checkoutBtn?.addEventListener("click", handleCheckout);

      await loadCartItems();
    } catch (error) {
      console.error("Initialize cart error:", error);
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng");
      showEmptyState();
    }
  }

  async function loadHeaderFooter() {
    try {
      const [headerHtml, footerHtml] = await Promise.all([
        fetch("/src/header.html").then((res) => res.text()),
        fetch("/src/footer.html").then((res) => res.text()),
      ]);
      const headerContainer = document.getElementById("header");
      const footerContainer = document.getElementById("footer");

      if (headerContainer) {
        headerContainer.innerHTML = headerHtml;
        await execScriptsIn(headerContainer);
        window.applyAuthUI?.();
      }
      if (footerContainer) {
        footerContainer.innerHTML = footerHtml;
        await execScriptsIn(footerContainer);
      }
    } catch (error) {
      console.warn("Kh√¥ng th·ªÉ t·∫£i header/footer", error);
    }
  }

  async function loadCartItems() {
    setLoading(true);
    try {
      const { items = [], meta } = await window.CartService.list({
        page: "1",
        limit: "50",
        includeDeleted: "false",
      });

      cartItems = Array.isArray(items) ? items : [];
      if (cartItems.length === 0) {
        showEmptyState();
        return;
      }

      renderCartItems(cartItems);
    } catch (error) {
      console.error("Load cart error:", error);
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng");
      showEmptyState();
    } finally {
      setLoading(false);
    }
  }

  function renderCartItems(items) {
    totalPages = Math.ceil(items.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const itemsToShow = items.slice(startIndex, endIndex);

    cartBody.innerHTML = itemsToShow.map(createCartRowHtml).join("");

    const totalItems = items.reduce(
      (acc, item) => acc + Number(item.quantity || item.qty || 0),
      0
    );
    cartCountEl.textContent = totalItems;

    updateCartTotal();
    toggleEmptyState(false);
    attachRowEventHandlers();
    renderPagination();

    // üî• n·∫°p ·∫£nh t·ª´ API n·∫øu v·∫´n c√≤n placeholder
    hydrateImagesForCurrentPage();
  }

  function createCartRowHtml(item) {
    const cartItemId = item._id || item.id;
    const product = item.product || {};
    const productId = product._id || product.id || item.productId;
    const quantity = Number(item.quantity || item.qty || 0) || 0;
    const price = Number(item.price || product.price || 0) || 0;

    const placeholderImage =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='14' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E";

    // ·∫£nh c√≥ s·∫µn trong product (n·∫øu BE tr·∫£ v·ªÅ)
    let imagePath = "";
    if (Array.isArray(product.images) && product.images.length > 0) {
      const primary = product.images.find(
        (im) => im && typeof im === "object" && im.isPrimary
      );
      if (primary) imagePath = primary.url || primary.path || "";
      if (!imagePath) {
        const first = product.images[0];
        imagePath =
          typeof first === "string" ? first : first?.url || first?.path || "";
      }
    }
    if (!imagePath)
      imagePath =
        product.thumbnail ||
        product.image ||
        __cartImgCache.get(productId) ||
        "";

    const image = imagePath ? buildImg(imagePath) : placeholderImage;
    const name = product?.name || item.productName || "S·∫£n ph·∫©m";

    return `
      <tr data-id="${cartItemId}" data-pid="${
      productId || ""
    }" data-price="${price}">
        <td class="d-flex align-items-center">
          <img
            src="${image}"
            alt="${name}"
            class="rounded me-3 cart-row-img"
            style="width: 60px; height: 60px; object-fit: cover"
            onerror="this.src='${placeholderImage}'"
          />
          <div><div class="fw-semibold">${name}</div></div>
        </td>
        <td class="text-center">
          <div class="d-flex justify-content-center align-items-center">
            <button class="btn btn-sm btn-outline-secondary qty-btn" data-action="decrease">-</button>
            <input
              type="number"
              class="form-control text-center mx-1 px-1 quantity-input"
              value="${quantity}"
              min="1"
              style="width: 50px"
              data-action="input"
            />
            <button class="btn btn-sm btn-outline-secondary qty-btn" data-action="increase">+</button>
          </div>
        </td>
        <td class="text-end fw-semibold">${formatCurrency(price)}</td>
        <td class="text-end ps-2">
          <button class="remove-btn-icon" data-action="remove" title="Remove from cart">
            <i class="fas fa-trash text-danger"></i>
          </button>
        </td>
      </tr>
    `;
  }

  function attachRowEventHandlers() {
    cartBody.querySelectorAll("tr").forEach((row) => {
      row
        .querySelector('[data-action="decrease"]')
        .addEventListener("click", () => changeQuantity(row.dataset.id, -1));
      row
        .querySelector('[data-action="increase"]')
        .addEventListener("click", () => changeQuantity(row.dataset.id, 1));
      row
        .querySelector('[data-action="remove"]')
        .addEventListener("click", () => removeCartItem(row.dataset.id));

      const qtyInput = row.querySelector('[data-action="input"]');
      qtyInput.addEventListener("change", () => {
        const newQty = parseInt(qtyInput.value) || 1;
        if (newQty < 1) {
          qtyInput.value = 1;
          return;
        }
        updateQuantityDirect(row.dataset.id, newQty);
      });
      qtyInput.addEventListener("input", (e) => {
        if (e.target.value < 1) e.target.value = 1;
      });
    });
  }

  async function changeQuantity(cartItemId, delta) {
    const row = cartBody.querySelector(`tr[data-id="${cartItemId}"]`);
    if (!row) return;
    const input = row.querySelector(".quantity-input");
    const currentQty = Number(input.value) || 0;
    const nextQty = currentQty + delta;
    if (nextQty <= 0) {
      const confirmed = confirm("B·∫°n c√≥ mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè?");
      if (!confirmed) return;
      await removeCartItem(cartItemId);
      return;
    }
    try {
      await window.CartService.update(cartItemId, { quantity: nextQty });
      input.value = nextQty;
      updateCartStateAfterChange();
      window.Toast?.success?.("C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng");
    } catch (error) {
      console.error("Update quantity error:", error);
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng");
    }
  }

  async function updateQuantityDirect(cartItemId, newQty) {
    const row = cartBody.querySelector(`tr[data-id="${cartItemId}"]`);
    if (!row) return;
    const input = row.querySelector(".quantity-input");
    const oldQty = Number(input.value) || 1;
    if (newQty === oldQty) return;
    try {
      await window.CartService.update(cartItemId, { quantity: newQty });
      input.value = newQty;
      updateCartStateAfterChange();
      window.Toast?.success?.("C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng");
    } catch (error) {
      console.error("Update quantity error:", error);
      input.value = oldQty;
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng");
    }
  }

  async function removeCartItem(cartItemId) {
    try {
      await window.CartService.remove(cartItemId);
      cartItems = cartItems.filter(
        (item) => (item._id || item.id) !== cartItemId
      );
      cartBody.querySelector(`tr[data-id="${cartItemId}"]`)?.remove();
      updateCartStateAfterChange();
      window.Toast?.success?.("ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng");
    } catch (error) {
      console.error("Remove cart item error:", error);
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m");
    }
  }

  async function handleClearCart() {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?")) return;
    try {
      await window.CartService.clear();
      cartItems = [];
      cartBody.innerHTML = "";
      updateCartStateAfterChange();
      window.Toast?.success?.("ƒê√£ x√≥a to√†n b·ªô gi·ªè h√†ng");
    } catch (error) {
      console.error("Clear cart error:", error);
      window.Toast?.error?.(error.message || "Kh√¥ng th·ªÉ x√≥a to√†n b·ªô gi·ªè h√†ng");
    }
  }

  function updateCartStateAfterChange() {
    const rows = Array.from(cartBody.querySelectorAll("tr[data-id]")).map(
      (row) => {
        const id = row.dataset.id;
        const quantity = Number(
          row.querySelector(".quantity-input")?.value || 0
        );
        return { id, quantity };
      }
    );

    cartItems = cartItems.map((item) => {
      const found = rows.find((row) => row.id === (item._id || item.id));
      return found ? { ...item, quantity: found.quantity } : item;
    });

    const totalItems = cartItems.reduce(
      (acc, item) => acc + Number(item.quantity || item.qty || 0),
      0
    );
    cartCountEl.textContent = totalItems;

    if (cartItems.length > 0) {
      totalPages = Math.ceil(cartItems.length / itemsPerPage);
      if (currentPage > totalPages) currentPage = totalPages;
      renderCartItems(cartItems);
    }

    updateCartTotal();
    toggleEmptyState(cartItems.length === 0);
  }

  function updateCartTotal() {
    const total = cartItems.reduce((sum, item) => {
      const price = Number(item.price || item.product?.price || 0);
      const qty = Number(item.quantity || item.qty || 0);
      return sum + price * qty;
    }, 0);
    cartTotalEl.textContent = formatCurrency(total);
  }

  function renderPagination() {
    if (totalPages <= 1) {
      cartPagination.style.display = "none";
      return;
    }
    cartPagination.style.display = "block";
    let html = "";

    html += `
      <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
        <a class="page-link" href="#" onclick="changePage(${
          currentPage - 1
        }); return false;">‚Äπ</a>
      </li>
    `;

    if (totalPages <= 5) {
      for (let i = 1; i <= totalPages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? "active" : ""}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
    } else {
      if (currentPage > 1) {
        html += `
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>
        `;
        if (currentPage > 2)
          html +=
            '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
      }
      html += `
        <li class="page-item active"><a class="page-link" href="#" onclick="return false;">${currentPage}</a></li>
      `;
      if (currentPage < totalPages) {
        if (currentPage < totalPages - 1)
          html +=
            '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
        html += `
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>
        `;
      }
    }

    html += `
      <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
        <a class="page-link" href="#" onclick="changePage(${
          currentPage + 1
        }); return false;">‚Ä∫</a>
      </li>
    `;
    paginationList.innerHTML = html;
  }

  window.changePage = function (page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    currentPage = page;
    renderCartItems(cartItems);
  };

  function toggleEmptyState(isEmpty) {
    cartTable.style.display = isEmpty ? "none" : "";
    cartActions.style.display = isEmpty ? "none" : "";
    cartTotalWrapper.style.display = isEmpty ? "none" : "";
    cartPagination.style.display = isEmpty ? "none" : "";
    emptyState.style.display = isEmpty ? "" : "none";
  }

  function showEmptyState() {
    cartBody.innerHTML = "";
    cartCountEl.textContent = "0";
    cartTotalEl.textContent = formatCurrency(0);
    toggleEmptyState(true);
  }

  function setLoading(loading) {
    const loadingRow = document.getElementById("cartLoadingRow");
    if (!loadingRow) return;
    loadingRow.style.display = loading ? "table-row" : "none";
  }

  function formatCurrency(value) {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
      maximumFractionDigits: 0,
    }).format(Number(value) || 0);
  }

  function handleCheckout(event) {
    event?.preventDefault();
    if (cartItems.length === 0) {
      window.Toast?.info?.("Gi·ªè h√†ng ƒëang tr·ªëng");
      return;
    }
    window.location.href = "/src/pages/cart/checkout.html";
  }
  // Th√™m helper join base + path
  function makeApiUrl(path) {
    const BASE =
      (window.API_CONFIG &&
        (window.API_CONFIG.BASE_URL || window.API_CONFIG.API_BASE)) ||
      window.API?.BASE_URL ||
      "http://localhost:8080/api/v1"; // fallback

    const base = String(BASE).replace(/\/+$/, "");
    const p = String(path || "").replace(/^\/+/, "");
    return `${base}/${p}`;
  }

  // ƒê√∫ng URL /product/{id}/images tr√™n API BASE (8080)
  function resolveProductImagesUrl(productId) {
    return makeApiUrl(`product/${encodeURIComponent(productId)}/images`);
  }
</script>
