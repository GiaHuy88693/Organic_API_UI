<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đơn hàng của tôi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8f9fa;
    }
    .order-card {
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .order-status {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-completed {
      background-color: #d1e7dd;
      color: #0f5132;
    }
    .status-cancelled {
      background-color: #f8d7da;
      color: #842029;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <div class="container my-5">
    <div class="card shadow-sm rounded-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0 fw-bold">
            <i class="fas fa-shopping-bag me-2 text-success"></i>
            Đơn hàng của tôi
          </h4>
          <a href="/src/pages/account/dashboard.html" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
          </a>
        </div>

        <!-- Orders List -->
        <div id="ordersList">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Pagination -->
        <nav id="paginationContainer" class="mt-4 d-none">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="orderDetailBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script type="module" src="/src/js/config/api.config.js"></script>
  <script type="module" src="/src/js/utils/http.client.js"></script>
  <script type="module" src="/src/js/utils/toast.js"></script>
  <script type="module" src="/src/js/services/order.service.js"></script>

  <script type="module">
    import { showToast } from '/src/js/utils/toast.js';

    let currentPage = 1;
    const limit = 10;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadHeaderFooter();
      loadOrders();
    });

    async function loadHeaderFooter() {
      try {
        const [headerHtml, footerHtml] = await Promise.all([
          fetch("/src/header.html").then((res) => res.text()),
          fetch("/src/footer.html").then((res) => res.text()),
        ]);

        document.getElementById("header").innerHTML = headerHtml;
        document.getElementById("footer").innerHTML = footerHtml;

        execScriptsIn(document.getElementById("header"));
        execScriptsIn(document.getElementById("footer"));

        // Fix dropdown
        setTimeout(() => {
          const userDropdown = document.getElementById('userDropdown');
          if (userDropdown) {
            userDropdown.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const dropdownInstance = bootstrap.Dropdown.getOrCreateInstance(userDropdown);
              dropdownInstance.toggle();
            });
          }
        }, 100);
      } catch (error) {
        console.error("Error loading header/footer:", error);
      }
    }

    function execScriptsIn(container) {
      if (!container) return;
      const scripts = Array.from(container.querySelectorAll("script"));
      scripts.forEach((oldScript) => {
        const newScript = document.createElement("script");
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }

    async function loadOrders(page = 1) {
      currentPage = page;
      const container = document.getElementById('ordersList');

      try {
        container.innerHTML = `
          <div class="text-center py-5">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Đang tải...</span>
            </div>
          </div>
        `;

        const response = await window.OrderService.list({ page, limit });
        const { items, pagination } = response;

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div class="text-center py-5">
              <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
              <p class="text-muted">Bạn chưa có đơn hàng nào</p>
              <a href="/src/pages/product/list.html" class="btn btn-success">
                <i class="fas fa-shopping-cart me-2"></i>Mua sắm ngay
              </a>
            </div>
          `;
          document.getElementById('paginationContainer').classList.add('d-none');
          return;
        }

        renderOrders(items);
        renderPagination(pagination);
      } catch (error) {
        console.error('Error loading orders:', error);
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Không thể tải danh sách đơn hàng: ${error.message}
          </div>
        `;
      }
    }

    function renderOrders(orders) {
      const container = document.getElementById('ordersList');
      
      container.innerHTML = orders.map(order => {
        const orderDate = new Date(order.createdAt).toLocaleDateString('vi-VN');
        const total = formatPrice(order.total || 0);
        const status = order.status || 'pending';
        const statusClass = `status-${status}`;
        const statusText = getStatusText(status);

        return `
          <div class="order-card card mb-3" onclick="viewOrderDetail('${order._id || order.id}')">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-2">
                  <small class="text-muted">Mã đơn</small>
                  <div class="fw-bold">#${(order._id || order.id).slice(-6).toUpperCase()}</div>
                </div>
                <div class="col-md-2">
                  <small class="text-muted">Ngày đặt</small>
                  <div>${orderDate}</div>
                </div>
                <div class="col-md-2">
                  <small class="text-muted">Số lượng</small>
                  <div>${order.items?.length || 0} sản phẩm</div>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Tổng tiền</small>
                  <div class="fw-bold text-success">${total}</div>
                </div>
                <div class="col-md-2">
                  <span class="order-status ${statusClass}">${statusText}</span>
                </div>
                <div class="col-md-1 text-end">
                  <i class="fas fa-chevron-right text-muted"></i>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPagination(pagination) {
      if (!pagination || pagination.totalPages <= 1) {
        document.getElementById('paginationContainer').classList.add('d-none');
        return;
      }

      document.getElementById('paginationContainer').classList.remove('d-none');
      const container = document.getElementById('pagination');
      const { page, totalPages } = pagination;

      let html = '';

      // Previous button
      html += `
        <li class="page-item ${page === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadOrders(${page - 1}); return false;">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>
      `;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
          html += `
            <li class="page-item ${i === page ? 'active' : ''}">
              <a class="page-link" href="#" onclick="loadOrders(${i}); return false;">${i}</a>
            </li>
          `;
        } else if (i === page - 3 || i === page + 3) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      // Next button
      html += `
        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadOrders(${page + 1}); return false;">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      `;

      container.innerHTML = html;
    }

    window.viewOrderDetail = async function(orderId) {
      const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
      const body = document.getElementById('orderDetailBody');

      try {
        body.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-success" role="status"></div>
          </div>
        `;

        modal.show();

        const order = await window.OrderService.getDetail(orderId);
        
        const orderDate = new Date(order.createdAt).toLocaleDateString('vi-VN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        body.innerHTML = `
          <div class="mb-4">
            <h6 class="text-muted mb-3">Thông tin đơn hàng</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Mã đơn:</strong> #${(order._id || order.id).slice(-6).toUpperCase()}</p>
                <p><strong>Ngày đặt:</strong> ${orderDate}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Trạng thái:</strong> <span class="order-status status-${order.status}">${getStatusText(order.status)}</span></p>
                <p><strong>Tổng tiền:</strong> <span class="text-success fw-bold">${formatPrice(order.total)}</span></p>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <h6 class="text-muted mb-3">Sản phẩm</h6>
            <div class="table-responsive">
              <table class="table">
                <thead class="table-light">
                  <tr>
                    <th>Sản phẩm</th>
                    <th class="text-center">Số lượng</th>
                    <th class="text-end">Đơn giá</th>
                    <th class="text-end">Thành tiền</th>
                  </tr>
                </thead>
                <tbody>
                  ${order.items.map(item => {
                    const product = item.product || {};
                    return `
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <img src="${product.images?.[0] || 'https://via.placeholder.com/50'}" 
                                 alt="${product.name}" 
                                 class="rounded me-2" 
                                 style="width: 50px; height: 50px; object-fit: cover;">
                            <div>
                              <div class="fw-semibold">${product.name}</div>
                              <small class="text-muted">${product.category?.name || ''}</small>
                            </div>
                          </div>
                        </td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">${formatPrice(item.price)}</td>
                        <td class="text-end fw-bold">${formatPrice(item.price * item.quantity)}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                    <td class="text-end fw-bold text-success">${formatPrice(order.total)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading order detail:', error);
        body.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Không thể tải chi tiết đơn hàng: ${error.message}
          </div>
        `;
      }
    };

    function formatPrice(price) {
      return new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND' 
      }).format(price);
    }

    function getStatusText(status) {
      const statusMap = {
        pending: 'Chờ xử lý',
        processing: 'Đang xử lý',
        shipping: 'Đang giao',
        completed: 'Hoàn thành',
        cancelled: 'Đã hủy'
      };
      return statusMap[status] || status;
    }

    // Expose functions globally
    window.loadOrders = loadOrders;
  </script>
</body>
</html>
