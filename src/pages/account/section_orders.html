<!-- section_orders.html -->
<div class="ord-orders">
  <h2 class="ord-orders__title">Recent Order History</h2>

  <div id="ordLoading" class="ord-orders__loading" style="display: none">
    <i class="fa-solid fa-spinner fa-spin"></i> Loading orders...
  </div>

  <div id="ordEmpty" class="ord-orders__empty" style="display: none">
    <i class="fa-regular fa-face-smile"></i> You have no orders yet.
  </div>

  <table class="ord-orders__table" id="ordTable" style="display: none">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Date</th>
        <th>Total</th>
        <th>Quantity</th>
        <th>Status</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="ordTbody"></tbody>
  </table>
</div>

<style>
  /* chỉ áp cho orders page, tránh đụng dashboard */
  .ord-orders {
    max-width: 1000px;
    padding: 0 1rem;
  }
  .ord-orders__title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }
  .ord-orders__table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }
  .ord-orders__table th,
  .ord-orders__table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
  }
  .ord-orders__table th {
    background-color: #f9f9f9;
    font-weight: 600;
    color: #555;
  }
  .ord-orders__table td strong {
    color: #198754;
  }
  .ord-orders .status {
    text-transform: capitalize;
  }
  .ord-orders .view-link {
    color: #198754;
    font-weight: 500;
    text-decoration: none;
  }
  .ord-orders .view-link:hover {
    text-decoration: underline;
  }
  .ord-orders__table td.ord-id,
.ord-orders__table td.ord-id a {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  white-space: nowrap;
  max-width: 360px;
  overflow: hidden;
  text-overflow: ellipsis; /* nếu bạn muốn rút gọn hiển thị nhưng link vẫn là ID thật */
  display: inline-block;
  vertical-align: top;
}
</style>

<script>
  (function () {
    "use strict";

    // Có thể đổi LIMIT tuỳ nhu cầu trang orders; để 10 cho "bình thường"
    const LIMIT = 10;

    const tbody = document.getElementById("ordTbody");
    const tbl = document.getElementById("ordTable");
    const emptyBox = document.getElementById("ordEmpty");
    const loadingBox = document.getElementById("ordLoading");

    const fmtMoney = (n) =>
      new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
        maximumFractionDigits: 0,
      }).format(Number(n || 0));
    const fmtDate = (d) => {
      try {
        return new Date(d).toLocaleDateString("vi-VN");
      } catch {
        return d || "";
      }
    };
    const normMsg = (m) =>
      m?.message ||
      (Array.isArray(m)
        ? m.map((x) => x?.message || x).join(", ")
        : typeof m === "object"
        ? JSON.stringify(m)
        : String(m || ""));

    const getId = (o) => o.id || o._id || o.orderId || o.code || "";
    const getTotal = (o) =>
      o.totalAmount ?? o.totalPrice ?? o.total ?? o.amount ?? o.grandTotal ?? 0;
    const getQty = (o) =>
      typeof o.totalQuantity === "number"
        ? o.totalQuantity
        : Array.isArray(o.items)
        ? o.items.reduce((a, it) => a + Number(it.quantity ?? it.qty ?? 0), 0)
        : Array.isArray(o.products)
        ? o.products.length
        : Number(o.quantity || 0);
    const getStatus = (o) =>
      (o.status || o.state || o.orderStatus || "pending") + "";
    const getDate = (o) =>
      fmtDate(
        o.createdAt || o.created_at || o.date || o.placedAt || Date.now()
      );

    const detailHref = (o) =>
      `/src/pages/account/order-detail.html?id=${encodeURIComponent(getId(o))}`;

    const row = (o) => {
      const realId = String(getId(o));
      const href = `/src/pages/account/order-detail.html?id=${encodeURIComponent(
        realId
      )}`;
      return `
    <tr>
      <td class="ord-id">
        <a class="ord-id-link" href="${href}" title="View order detail">${realId}</a>
      </td>
      <td>${getDate(o)}</td>
      <td><strong>${fmtMoney(getTotal(o))}</strong></td>
      <td>${getQty(o) || 0} ${getQty(o) > 1 ? "Products" : "Product"}</td>
      <td class="status">${getStatus(o).toLowerCase()}</td>
      <td>
        <a class="view-link" href="${href}" title="View detail" aria-label="View detail">
          <i class="fas fa-eye"></i>
        </a>
      </td>
    </tr>`;
    };

    function resolveOrdersUrl(p) {
      const base =
        window.API?.ORDER?.PAGINATION ||
        window.API?.ORDERS?.PAGINATION ||
        window.API?.ORDER?.LIST_MINE ||
        window.API?.ORDERS?.LIST_MINE ||
        window.API?.ORDER?.LIST ||
        window.API?.ORDERS?.LIST ||
        "/api/v1/order/pagination";
      const qs = new URLSearchParams(
        Object.fromEntries(Object.entries(p || {}).filter(([, v]) => v != null))
      ).toString();
      return qs ? `${base}?${qs}` : base;
    }

    async function fetchOrders(limit) {
      if (window.OrderService?.listMine) {
        const r = await window.OrderService.listMine({
          page: "1",
          limit: String(limit),
        });
        return r?.items || r?.data || [];
      }
      if (window.OrderService?.list) {
        const r = await window.OrderService.list({
          page: "1",
          limit: String(limit),
          mine: true,
        });
        return r?.items || r?.data || [];
      }
      const url = resolveOrdersUrl({ page: "1", limit: String(limit) });
      const res = await window.HttpClient.request(url, {
        method: "GET",
        withAuth: true,
      });
      if (!res?.ok)
        throw new Error(normMsg(res?.message) || "Không thể tải đơn hàng");
      const payload = res.data ?? res;
      return payload?.items || payload?.data || payload || [];
    }

    async function loadOrders() {
      try {
        loadingBox.style.display = "block";
        emptyBox.style.display = "none";
        tbl.style.display = "none";

        const token =
          localStorage.getItem("access_token") ||
          localStorage.getItem("accessToken");
        if (!token) {
          emptyBox.style.display = "block";
          return;
        }

        const orders = await fetchOrders(LIMIT);
        if (!orders.length) {
          emptyBox.style.display = "block";
          return;
        }

        tbody.innerHTML = orders.map(row).join("");
        tbl.style.display = "";
      } catch (err) {
        console.error("Orders page error:", err);
        emptyBox.style.display = "block";
        window.Toast?.error?.(err.message || "Không thể tải đơn hàng");
      } finally {
        loadingBox.style.display = "none";
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", loadOrders);
    } else {
      loadOrders();
    }
  })();
</script>
