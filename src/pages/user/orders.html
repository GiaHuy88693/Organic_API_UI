<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng của tôi - Organic Store</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        body {
            font-family: 'Poppins', Arial, Helvetica, sans-serif;
            background: #f8f9fa;
        }
        
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .order-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-weight: 600;
            color: #28a745;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background: #cfe2ff;
            color: #084298;
        }
        
        .status-shipped {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .status-delivered {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #842029;
        }
        
        .order-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
        }
        
        .order-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .order-total {
            font-size: 20px;
            font-weight: 700;
            color: #28a745;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .sidebar .nav-link {
            color: #6c757d;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-success" href="/index.html">
                <i class="bi bi-shop"></i> Organic Store
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="sidebar">
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/pages/user/dashboard.html">
                            <i class="bi bi-grid"></i> Dashboard
                        </a>
                        <a class="nav-link active" href="/pages/user/orders.html">
                            <i class="bi bi-bag"></i> Đơn hàng
                        </a>
                        <a class="nav-link" href="/pages/user/profile.html">
                            <i class="bi bi-person"></i> Thông tin cá nhân
                        </a>
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Đăng xuất
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Orders List -->
            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">Đơn hàng của tôi</h3>
                    <select class="form-select w-auto" id="statusFilter" onchange="filterOrders()">
                        <option value="">Tất cả</option>
                        <option value="pending">Chờ xử lý</option>
                        <option value="processing">Đang xử lý</option>
                        <option value="shipped">Đang giao</option>
                        <option value="delivered">Đã giao</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>

                <div id="ordersContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-3">Đang tải đơn hàng...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config -->
    <script src="/assets/js/config.js"></script>

    <!-- API Service -->
    <script src="/assets/js/api-service.js"></script>
    
    <script>
        // Protect route
        if (!AuthAPI.isLoggedIn()) {
            window.location.href = '/pages/auth/login.html';
        }

        let currentPage = 0;
        const pageSize = 10;
        let currentFilter = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });

        // Load orders
        async function loadOrders() {
            try {
                const response = await OrderAPI.getOrders({
                    skip: currentPage * pageSize,
                    take: pageSize,
                    status: currentFilter,
                });

                if (response.success && response.data) {
                    renderOrders(response.data.orders || response.data.items || []);
                    renderPagination(response.data.total || 0);
                }
            } catch (error) {
                console.error('Load orders error:', error);
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="alert alert-danger">
                        Không thể tải đơn hàng. Vui lòng thử lại sau.
                    </div>
                `;
            }
        }

        // Render orders
        function renderOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-bag-x fs-1 text-muted d-block mb-3"></i>
                        <h5 class="text-muted mb-3">Chưa có đơn hàng nào</h5>
                        <a href="/index.html" class="btn btn-success">
                            Mua sắm ngay <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <span class="order-id">#${order._id.substring(0, 8)}</span>
                            <span class="text-muted ms-3">
                                <i class="bi bi-calendar"></i>
                                ${formatDate(order.createdAt)}
                            </span>
                        </div>
                        <span class="status-badge status-${order.status}">
                            ${getStatusText(order.status)}
                        </span>
                    </div>

                    <div class="order-body">
                        ${(order.items || []).map(item => `
                            <div class="order-item">
                                <img src="${item.product?.image || 'https://via.placeholder.com/80'}" 
                                     alt="${item.product?.name}" 
                                     class="order-item-image">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${item.product?.name || 'Sản phẩm'}</h6>
                                    <p class="text-muted small mb-0">
                                        Số lượng: ${item.quantity} × ${formatPrice(item.price)}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <p class="mb-0 fw-bold">${formatPrice(item.price * item.quantity)}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-3">
                        <span class="order-total">Tổng: ${formatPrice(order.total)}</span>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetail('${order._id}')">
                                <i class="bi bi-eye"></i> Chi tiết
                            </button>
                            ${order.status === 'pending' ? `
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="cancelOrder('${order._id}')">
                                    <i class="bi bi-x-circle"></i> Hủy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render pagination
        function renderPagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || Math.abs(i - currentPage) <= 1) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
                        </li>
                    `;
                } else if (Math.abs(i - currentPage) === 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Filter orders
        function filterOrders() {
            currentFilter = document.getElementById('statusFilter').value;
            currentPage = 0;
            loadOrders();
        }

        // View order detail
        function viewOrderDetail(orderId) {
            // Open modal or navigate to detail page
            showToast('Tính năng đang phát triển', 'info');
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
                return;
            }

            try {
                await OrderAPI.deleteOrder(orderId);
                loadOrders();
            } catch (error) {
                console.error('Cancel order error:', error);
            }
        }

        // Helpers
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
            }).format(price);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('vi-VN');
        }

        function getStatusText(status) {
            const statusMap = {
                pending: 'Chờ xử lý',
                processing: 'Đang xử lý',
                shipped: 'Đang giao',
                delivered: 'Đã giao',
                cancelled: 'Đã hủy',
            };
            return statusMap[status] || status;
        }

        async function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                await AuthAPI.logout();
            }
        }
    </script>
</body>
</html>